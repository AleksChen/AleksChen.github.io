---
import "@/styles/theme.css";
import "@/index.scss";
import Footer from "@/components/Footer.astro";
import SEO from "@/components/SEO.astro";
import config from "site.config";

interface Props {
  title?: string;
  description?: string;
  footer?: boolean;
  className?: string;
  seo?: {
    image?: string;
    type?: "website" | "article";
    publishedTime?: string;
    modifiedTime?: string;
    author?: string;
    tags?: string[];
    url?: string;
  };
}

const {
  title,
  description,
  footer = true,
  className = "max-w-[800px]",
  seo = {},
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="144x144"
      href="/favicon.png"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Blog" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed"
      href="/rss.xml"
    />
    <title>
      {[config.head.title, title].filter(Boolean).reverse().join(" | ")}
    </title>

    <SEO title={title} description={description} {...seo} />

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G1EC4WNBZJ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-G1EC4WNBZJ");
    </script>

    <!-- Privacy-friendly analytics by Plausible -->
    <script async src="https://plausible.io/js/pa-bqrNOvlYoay2S1opDAt9D.js"
    ></script>
    <script>
      ((window.plausible =
        window.plausible ||
        function () {
          (plausible.q = plausible.q || []).push(arguments);
        }),
        (plausible.init =
          plausible.init ||
          function (i) {
            plausible.o = i || {};
          }));
      plausible.init();
    </script>

    <script is:inline>
      // 暗色模式初始化
      const theme = (() => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      })();

      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      window.localStorage.setItem("theme", theme);
    </script>
  </head>
  <body
    class="bg-bg text-text min-h-screen flex flex-col font-sans transition-colors duration-300"
  >
    <header class="sticky top-0 z-50 w-full bg-bg border-b-2 border-text">
      <div
        class="max-w-[800px] mx-auto px-4 h-16 flex items-center justify-between"
      >
        <a
          href="/"
          class="text-xl font-bold flex items-center gap-2 hover:text-primary transition-colors"
          aria-label="homepage"
        >
          <div class="i-ri:home-4-line text-2xl"></div>
          <span class="hidden sm:inline-block">Aleks' Blog</span>
        </a>

        <div class="flex items-center gap-4">
          <slot name="operations" />

          <div class="flex items-center gap-3 border-l border-border pl-4">
            <a
              href={config.head.links.github}
              target="_blank"
              class="hover:text-primary transition-transform hover:scale-110"
              title="GitHub"
            >
              <div class="i-ri:github-fill w-6 h-6"></div>
            </a>
            <a
              href={config.head.links.juejin}
              target="_blank"
              class="hover:text-primary transition-transform hover:scale-110"
              title="Juejin"
            >
              <div class="i-ri:blogger-line w-6 h-6"></div>
            </a>

            <button
              id="theme-toggle"
              class="hover:text-primary transition-transform hover:scale-110 focus:outline-none"
              title="Toggle Theme"
            >
              <div class="i-ri:sun-line w-6 h-6 dark:hidden"></div>
              <div class="i-ri:moon-line w-6 h-6 hidden dark:block"></div>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main
      class={`flex-1 w-full mx-auto px-4 py-8 animate-fade-in ${className}`}
    >
      <slot />
    </main>

    {footer && <Footer />}

    <script>
      const handleToggleClick = () => {
        const element = document.documentElement;
        element.classList.toggle("dark");
        const isDark = element.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      };

      document
        .getElementById("theme-toggle")
        ?.addEventListener("click", handleToggleClick);
    </script>
  </body>
</html>
