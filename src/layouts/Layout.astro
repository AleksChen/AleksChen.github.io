---
import "@/styles/theme.css";
import "@/index.scss";
import Footer from "@/components/Footer.astro";
import SEO from "@/components/SEO.astro";
import config from "site.config";

interface Props {
  title?: string;
  description?: string;
  footer?: boolean;
  className?: string;
  seo?: {
    image?: string;
    type?: "website" | "article";
    publishedTime?: string;
    modifiedTime?: string;
    author?: string;
    tags?: string[];
    url?: string;
  };
}

const {
  title,
  description,
  footer = true,
  className = "max-w-[1200px]",
  seo = {},
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Blog" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="baidu-site-verification" content="codeva-tU6pIQVfyl" />
    <meta name="msvalidate.01" content="96ADAC3B4A010DE98F0350319BAF9DAB" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed"
      href="/rss.xml"
    />
    <link rel="icon" href="/favicon.ico" />
    <title>
      {title}
    </title>

    <SEO title={title} description={description} {...seo} />

    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-G1EC4WNBZJ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-G1EC4WNBZJ");
    </script> -->

    <!-- Privacy-friendly analytics by Plausible -->
    <script async src="https://plausible.io/js/pa-bqrNOvlYoay2S1opDAt9D.js"
    ></script>
    <script>
      ((window.plausible =
        window.plausible ||
        function () {
          (plausible.q = plausible.q || []).push(arguments);
        }),
        (plausible.init =
          plausible.init ||
          function (i) {
            plausible.o = i || {};
          }));
      plausible.init();
    </script>

    <script is:inline>
      // 暗色模式初始化
      const theme = (() => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      })();

      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      window.localStorage.setItem("theme", theme);
    </script>
  </head>
  <body
    class="bg-bg text-text min-h-screen flex flex-col font-sans transition-colors duration-300"
  >
    <slot name="background" />
    <header
      id="main-header"
      class="sticky top-0 z-50 w-full bg-bg border-b-2 border-text transition-transform duration-300"
    >
      <div
        class="max-w-[800px] mx-auto px-4 h-16 flex items-center justify-between"
      >
        <a
          href="/"
          class="text-xl font-bold flex items-center gap-2 hover:text-primary transition-colors"
          aria-label="homepage"
        >
          <div class="i-ri:home-4-line w-6 h-6"></div>
        </a>

        <div class="flex items-center gap-4">
          <nav class="hidden md:flex items-center gap-6">
            <a
              href="/archives"
              class="text-sm font-medium hover:text-primary transition-colors"
            >
              归档
            </a>
            <a
              href="/tags"
              class="text-sm font-medium hover:text-primary transition-colors"
            >
              标签
            </a>
            <a
              href="/about"
              class="text-sm font-medium hover:text-primary transition-colors"
            >
              关于
            </a>
          </nav>
          <slot name="operations" />

          <div class="flex items-center gap-3 pl-4 border-l border-text">
            <a
              href={config.head.links.github}
              target="_blank"
              class="hover:text-primary transition-transform hover:scale-110"
              title="GitHub"
            >
              <div class="i-ri:github-fill w-6 h-6"></div>
            </a>

            <button
              id="theme-toggle"
              class="hover:text-primary transition-transform hover:scale-110 focus:outline-none"
              title="Toggle Theme"
            >
              <div class="i-ri:sun-line w-6 h-6 dark:hidden"></div>
              <div class="i-ri:moon-line w-6 h-6 hidden dark:block"></div>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main
      class={`flex-1 w-full mx-auto px-4 py-8 animate-fade-in ${className}`}
    >
      <slot />
    </main>

    {footer && <Footer />}

    <script>
      const handleToggleClick = () => {
        const element = document.documentElement;
        element.classList.toggle("dark");
        const isDark = element.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      };

      document
        .getElementById("theme-toggle")
        ?.addEventListener("click", handleToggleClick);
    </script>

    <script>
      let lastScrollY = window.scrollY;
      const header = document.getElementById("main-header");

      const updateHeader = () => {
        const currentScrollY = window.scrollY;

        if (!header) return;

        // 向上滚动或在顶部时显示
        if (currentScrollY < lastScrollY || currentScrollY <= 100) {
          header.classList.remove("-translate-y-full");
        }
        // 向下滚动且超过阈值时隐藏
        else if (currentScrollY > 100 && currentScrollY > lastScrollY) {
          header.classList.add("-translate-y-full");
        }

        lastScrollY = currentScrollY;
      };

      window.addEventListener("scroll", updateHeader, { passive: true });
    </script>

    <script>
      let originalTitle = document.title;
      let timeoutId: number | undefined;

      document.addEventListener("visibilitychange", () => {
        const icon = document.querySelector(
          "link[rel*='icon']"
        ) as HTMLLinkElement | null;

        if (document.hidden) {
          if (
            document.title !== "快回来吧 T_T" &&
            document.title !== "你来啦!OvO"
          ) {
            originalTitle = document.title;
          }

          document.title = "快回来吧 T_T";
          if (icon) icon.href = "/failure.ico";
          
          if (timeoutId) clearTimeout(timeoutId);
        } else {
          document.title = "你来啦!OvO";
          if (icon) icon.href = "/favicon.ico";

          timeoutId = window.setTimeout(() => {
            document.title = originalTitle;
          }, 1000);
        }
      });
    </script>
  </body>
</html>
