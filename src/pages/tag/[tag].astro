---
import Layout from "../../layouts/Layout.astro";
import { getPostList, type ShortPostData } from "@/lib/posts";

export async function getStaticPaths() {
  const allPosts = await getPostList();
  const tagsMap = new Map<string, ShortPostData[]>();
  allPosts.forEach((post) => {
    post.tags.forEach((tag) => {
      if (!tagsMap.has(tag)) {
        tagsMap.set(tag, []);
      }
      tagsMap.get(tag)?.push(post);
    });
  });

  return Array.from(tagsMap.entries()).map(([tag, posts]) => ({
    params: { tag },
    props: { tag, posts },
  }));
}

interface Props {
  tag: string;
  posts: ShortPostData[];
}

const { tag, posts } = Astro.props;
---

<script>
  import { mount as mountRelativeTime } from "../../components/RelativeTime";
  import { mount as mountSearch } from "../../components/Search";

  mountRelativeTime("data-acc-time");
  mountSearch("#search-container");
</script>

<Layout title={`Tag: ${tag}`}>
  <div slot="operations" id="editor-operarions" class="flex gap-2 items-center">
    <div id="search-container"></div>
  </div>

  <div class="flex flex-col gap-8">
    <section class="text-center py-8 md:py-12 animate-slide-in">
      <h1
        class="text-4xl md:text-5xl font-bold text-text mb-4 drop-shadow-[2px_2px_0_var(--color-text)]"
      >
        #{tag}
      </h1>
      <p class="text-text-muted text-lg max-w-2xl mx-auto">
        共 {posts?.length || 0} 篇文章
      </p>
    </section>

    <div class="flex flex-col gap-6">
      {
        posts?.map((item, index) => (
          <article
            class="group relative card transition-all duration-300"
            style={`animation-delay: ${index * 100}ms`}
          >
            <div class="flex flex-col md:flex-row gap-4 md:items-start justify-between">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 text-xs text-text-muted mb-2">
                  <span class="flex items-center gap-1">
                    <div class="i-ri:calendar-line" />
                    {new Date(item.createTime).toLocaleDateString()}
                  </span>
                </div>

                <h2 class="text-xl md:text-2xl font-bold text-text mb-3 line-clamp-2">
                  <a
                    href={`/post/${item.slug}`}
                    class="group-hover:underline decoration-2 underline-offset-4 transition-colors"
                  >
                    {item.title}
                  </a>
                </h2>

                <p class="text-text-muted text-sm md:text-base line-clamp-3 mb-4 leading-relaxed">
                  {item.intro || "暂无简介"}
                </p>

                <div class="flex flex-wrap gap-2 mt-auto">
                  {item.tags.map((t) => (
                    <a
                      href={`/tag/${encodeURIComponent(t)}`}
                      class={`inline-flex items-center px-2 py-0.5 rounded-sm text-xs font-bold border border-text text-text bg-transparent shadow-[2px_2px_0_0_var(--color-text)] hover:translate-y-[1px] hover:translate-x-[1px] hover:shadow-none transition-all ${t === tag ? "bg-text text-bg" : ""}`}
                    >
                      #{t}
                    </a>
                  ))}
                </div>
              </div>

              {item.cover && (
                <div class="flex-shrink-0 w-full md:w-32 h-32 md:h-24 rounded-sm overflow-hidden border-2 border-text shadow-[4px_4px_0_0_var(--color-text)]">
                  <a href={`/post/${item.slug}`} class="block w-full h-full">
                    <img
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                      src={item.cover.src}
                      alt={item.cover.alt || item.title}
                      loading="lazy"
                    />
                  </a>
                </div>
              )}
            </div>
          </article>
        ))
      }
    </div>
  </div>
</Layout>
