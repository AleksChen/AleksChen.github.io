---
import Layout from "@/layouts/Layout.astro";
import { getPostList, getPostBySlug } from "@/lib/posts";
import { marked } from "marked";
import config from "site.config";
import GithubSlugger from "github-slugger";

export async function getStaticPaths() {
  const posts = await getPostList(false);
  return posts.map((p, index) => ({
    params: { slug: p.slug },
    props: {
      // 按照列表顺序（通常是时间倒序）：index+1 是上一篇（旧），index-1 是下一篇（新）
      // 注意：这里的命名 prev/next 是基于“阅读流”还是“时间轴”？
      // 原代码：prev = index + 1, next = index - 1
      // 这意味着 "Prev" 指向旧文章，"Next" 指向新文章。
      prev: posts[index + 1] || null,
      next: posts[index - 1] || null,
    },
  }));
}

const { slug } = Astro.params;
const { prev, next } = Astro.props;
const post = await getPostBySlug(slug!);

if (!post) {
  return Astro.redirect("/404");
}

// 1. 生成 TOC 和 处理 Markdown
const slugger = new GithubSlugger();
const toc: { text: string; id: string; depth: number }[] = [];

const renderer = {
  heading(this: any, { text, depth, tokens }: { text: string; depth: number; tokens: any[] }) {
    const level = depth;
    const content = this.parser.parseInline(tokens);
    const id = slugger.slug(text);
    if (level <= 3) {
      toc.push({ text: content, id, depth: level });
    }
    return `<h${level} id="${id}">${content}</h${level}>`;
  },
} as any;

marked.use({ renderer });
const html = await marked.parse(post.body);
---

<Layout title={post.title} description={post.intro} className="max-w-[1200px]">
  <div class="grid grid-cols-1 layout-grid-cols gap-8 items-start">
    <article class="w-full min-w-0">
      {/* 文章头部信息 */}
      <header class="mb-8 pb-8 border-b border-border">
        <div class="flex flex-wrap gap-2 mb-4">
          {
            post.tags.map((tag) => (
              <a
                href={`/tag/${encodeURIComponent(tag)}`}
                class="px-2 py-1 text-xs font-bold rounded-sm border border-text text-text bg-transparent shadow-[2px_2px_0_0_var(--color-text)] hover:translate-y-[1px] hover:translate-x-[1px] hover:shadow-none transition-all"
              >
                #{tag}
              </a>
            ))
          }
        </div>

        <h1 class="text-3xl md:text-4xl font-bold mb-4 leading-tight text-text">
          {post.title}
        </h1>

        <div class="flex items-center gap-4 text-sm text-text-muted">
          <time datetime={post.date} class="flex items-center gap-1">
            <div class="i-ri:calendar-line"></div>
            {new Date(post.date).toLocaleDateString()}
          </time>
          {
            post.updatedAt && (
              <span class="flex items-center gap-1" title="最后更新时间">
                <div class="i-ri:time-line" />
                {new Date(post.updatedAt).toLocaleDateString()}
              </span>
            )
          }
        </div>
      </header>

      {/* Markdown 内容 */}
      <div
        class="prose prose-lg dark:prose-invert max-w-none prose-img:rounded-sm prose-img:border-2 prose-img:border-text prose-img:shadow-[4px_4px_0_0_var(--color-text)] prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-headings:scroll-mt-24"
        set:html={html}
      />

      {/* 底部导航 (无需 JS Mount) */}
      <nav
        class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-12 pt-8 border-t border-border"
      >
        {
          prev ? (
            <a
              href={`/post/${prev.slug}`}
              class="group flex flex-col gap-1 p-4 rounded-lg border-2 border-text shadow-[4px_4px_0_0_var(--color-text)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none transition-all"
            >
              <span class="text-xs text-text-muted flex items-center gap-1 group-hover:text-primary">
                <div class="i-ri:arrow-left-double-line" />
                上一篇
              </span>
              <span class="font-medium truncate text-text">{prev.title}</span>
            </a>
          ) : (
            <div />
          )
        }
        {
          next ? (
            <a
              href={`/post/${next.slug}`}
              class="group flex flex-col gap-1 p-4 rounded-lg border-2 border-text shadow-[4px_4px_0_0_var(--color-text)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none transition-all text-right"
            >
              <span class="text-xs text-text-muted flex items-center gap-1 justify-end group-hover:text-primary">
                下一篇
                <div class="i-ri:arrow-right-double-line" />
              </span>
              <span class="font-medium truncate text-text">{next.title}</span>
            </a>
          ) : (
            <div />
          )
        }
      </nav>

      {/* 评论区 */}
      {
        config.giscus && (
          <div class="giscus-container mt-12 pt-8 border-t border-border">
            <script {...config.giscus} />
          </div>
        )
      }
    </article>

    {/* 侧边栏大纲 (SSG 生成) */}
    <aside class="hidden lg:block sticky top-24">
      {
        toc.length > 0 && (
          <div class="p-4 rounded-lg border-2 border-text bg-card shadow-[4px_4px_0_0_var(--color-text)] max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar">
            <div class="text-sm font-bold text-text-muted mb-4 uppercase tracking-wider">
              目录
            </div>
            <nav class="flex flex-col gap-1 text-sm">
              {toc.map((heading) => (
                <a
                  href={`#${heading.id}`}
                  class="toc-link block py-1 px-2 text-text-muted hover:text-primary hover:bg-primary/5 rounded transition-colors truncate"
                  data-id={heading.id}
                  style={`padding-left: ${(heading.depth - 1) * 0.75}rem`}
                >
                  {heading.text}
                </a>
              ))}
            </nav>
          </div>
        )
      }
    </aside>
  </div>
</Layout>

<script>
  // TOC 滚动高亮逻辑
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          document.querySelectorAll(".toc-link").forEach((link) => {
            link.classList.toggle(
              "text-primary",
              link.getAttribute("data-id") === id
            );
            link.classList.toggle(
              "bg-primary/10",
              link.getAttribute("data-id") === id
            );
            link.classList.toggle(
              "font-medium",
              link.getAttribute("data-id") === id
            );
          });
        }
      });
    },
    {
      rootMargin: "-100px 0px -60% 0px", // 调整视口检测范围
    }
  );

  document.querySelectorAll("h1[id], h2[id], h3[id]").forEach((h) => {
    observer.observe(h);
  });
</script>

<style>
  @media (min-width: 1024px) {
    .layout-grid-cols {
      grid-template-columns: minmax(0, 1fr) 240px;
    }
  }
</style>
