---
import type { HTMLAttributes } from 'astro/types';

interface Props extends HTMLAttributes<'pre'> {}

const { class: className, ...props } = Astro.props;
// 尝试从 class 中提取语言，Shiki 通常会把 language-xx 放在 pre 或 code 上
// 如果 pre 上没有，可能在 slot 里的 code 上，但我们这里很难获取 slot 内容的 props
// 不过 Astro 的 MDX 集成通常会在 pre 上加上 language-xx 类名
const lang = className?.match(/language-(\w+)/)?.[1] || '';
---

<div class="code-block relative group my-6 rounded-lg overflow-hidden border border-border bg-[var(--shiki-bg)] shadow-sm">
  {
    lang && (
      <div class="flex items-center justify-between px-4 py-1.5 bg-black/10 dark:bg-white/5 text-xs text-text-muted border-b border-border/50 select-none">
        <span class="font-mono font-bold opacity-70">{lang.toUpperCase()}</span>
        <button 
          class="copy-btn flex items-center gap-1.5 px-2 py-0.5 rounded hover:bg-black/5 dark:hover:bg-white/10 transition-colors cursor-pointer"
          aria-label="Copy code"
        >
          <div class="i-ri:file-copy-line text-sm"></div>
          <span>Copy</span>
        </button>
      </div>
    )
  }
  
  <div class="relative">
    <pre class:list={[className, "!my-0 !p-4 overflow-x-auto custom-scrollbar text-sm leading-relaxed"]} {...props}><slot /></pre>
    {
      !lang && (
        <button 
          class="copy-btn absolute top-2 right-2 z-50 flex items-center gap-1.5 px-2 py-1 rounded bg-white/20 dark:bg-white/5 text-xs text-white hover:bg-primary/10 dark:hover:bg-white/15 transition-colors cursor-pointer opacity-0 group-hover:opacity-100"
          aria-label="Copy code"
        >
          <div class="i-ri:file-copy-line text-sm"></div>
          <span>Copy</span>
        </button>
      )
    }
  </div>
</div>

<script>
  function initCopyButtons() {
    document.querySelectorAll('.copy-block-init').forEach(el => el.remove());

    document.querySelectorAll('.code-block').forEach(block => {
      // 避免重复绑定
      if (block.hasAttribute('data-copy-init')) return;
      block.setAttribute('data-copy-init', 'true');

      const btn = block.querySelector('.copy-btn');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        const codeElement = block.querySelector('code');
        if (!codeElement) return;

        // 获取纯文本，忽略行号等可能的干扰元素（如果有）
        const text = codeElement.innerText;

        try {
          await navigator.clipboard.writeText(text);
          
          const icon = btn.querySelector('div');
          const span = btn.querySelector('span');
          
          if (icon) icon.className = 'i-ri:check-line text-blue-500 text-sm';
          if (span) {
             span.innerText = 'Copied!';
             span.className = 'text-blue-500';
          }

          setTimeout(() => {
            if (icon) icon.className = 'i-ri:file-copy-line text-sm';
            if (span) {
                span.innerText = 'Copy';
                span.className = '';
            }
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  // 支持 View Transitions
  document.addEventListener('astro:page-load', initCopyButtons);
  // 首次加载
  initCopyButtons();
</script>
