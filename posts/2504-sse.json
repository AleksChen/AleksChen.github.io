{"__ud_title":"SSE 服务端推送","__ud_tags":["Network"],"__ud_update_time":1764581328190,"__ud_create_time":1743665749000,"__ud_draft":false,"type":"doc","content":[{"type":"heading","attrs":{"level":1,"id":"SSE-服务端推送"},"content":[{"type":"text","text":"SSE 服务端推送"}]},{"type":"heading","attrs":{"level":2,"id":"引言"},"content":[{"type":"text","text":"引言"}]},{"type":"paragraph","content":[{"type":"text","text":"Server-Sent Events (SSE) 是一种服务器推送技术，允许服务器向客户端实时推送数据。在以下场景特别有用："}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"实时数据更新（如股票价格、天气信息）"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"社交媒体信息流"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"实时日志显示"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"进度通知"}]}]}]},{"type":"image","attrs":{"src":"/post-assets/m911icos-Pasted-image-20250402200626.png","alt":"Pasted image 20250402200626.png","title":null}},{"type":"paragraph"},{"type":"heading","attrs":{"level":2,"id":"SSE-的本质"},"content":[{"type":"text","text":"SSE 的本质"}]},{"type":"paragraph","content":[{"type":"text","text":"SSE 本质上是基于 HTTP 协议的单向通信机制："}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"使用 HTTP 长连接实现服务器到客户端的单向数据流"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"数据格式为纯文本，编码必须是 UTF-8"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"基于标准 HTTP 协议，无需特殊协议支持"}]}]}]},{"type":"heading","attrs":{"level":2,"id":"SSE-的特点"},"content":[{"type":"text","text":"SSE 的特点"}]},{"type":"orderedList","attrs":{"start":1,"type":null},"content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"单向通信：服务器到客户端的单向数据流"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"自动重连：断开后默认自动重连"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"简单易用：使用标准 HTTP，无需 WebSocket 的复杂配置"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"支持自定义事件"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"天然支持跨域（CORS）"}]}]}]},{"type":"heading","attrs":{"level":2,"id":"SSE-客户端-API"},"content":[{"type":"text","text":"SSE 客户端 API"}]},{"type":"paragraph","content":[{"type":"text","text":"基本使用示例："}]},{"type":"codeBlock","attrs":{"language":"javascript"},"content":[{"type":"text","text":"const evtSource = new EventSource('/events');\n\n// 监听消息\nevtSource.onmessage = function(event) {\n    const data = JSON.parse(event.data);\n    console.log(data);\n};\n\n// 监听连接打开\nevtSource.onopen = function() {\n    console.log('连接已建立');\n};\n\n// 监听错误\nevtSource.onerror = function(err) {\n    console.error('发生错误:', err);\n};\n\n// 监听自定义事件\nevtSource.addEventListener('custom-event', function(e) {\n    console.log('自定义事件:', e.data);\n});\n\n// 关闭连接\n// evtSource.close();"}]},{"type":"heading","attrs":{"level":2,"id":"SSE-服务端实现"},"content":[{"type":"text","text":"SSE 服务端实现"}]},{"type":"heading","attrs":{"level":3,"id":"数据格式"},"content":[{"type":"text","text":"数据格式"}]},{"type":"paragraph","content":[{"type":"text","text":"服务器发送的数据必须遵循特定格式："}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"每条消息以 "},{"type":"text","marks":[{"type":"code"}],"text":"data:"},{"type":"text","text":" 开头"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"每条消息以 "},{"type":"text","marks":[{"type":"code"}],"text":"\\n\\n"},{"type":"text","text":" 结尾"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"支持多个字段：data、event、id、retry"}]}]}]},{"type":"heading","attrs":{"level":3,"id":"data-字段"},"content":[{"type":"text","text":"data 字段"}]},{"type":"codeBlock","attrs":{"language":"text"},"content":[{"type":"text","text":"data: 消息内容\\n\\n"}]},{"type":"paragraph","content":[{"type":"text","text":"多行数据："}]},{"type":"codeBlock","attrs":{"language":"text"},"content":[{"type":"text","text":"data: 第一行\\n\ndata: 第二行\\n\\n"}]},{"type":"heading","attrs":{"level":3,"id":"id-字段"},"content":[{"type":"text","text":"id 字段"}]},{"type":"paragraph","content":[{"type":"text","text":"用于消息标识，断线重连时会发送 "},{"type":"text","marks":[{"type":"code"}],"text":"Last-Event-ID"},{"type":"text","text":" 头："}]},{"type":"codeBlock","attrs":{"language":"text"},"content":[{"type":"text","text":"id: 1\\n\ndata: 消息内容\\n\\n"}]},{"type":"heading","attrs":{"level":3,"id":"event-字段"},"content":[{"type":"text","text":"event 字段"}]},{"type":"paragraph","content":[{"type":"text","text":"用于指定事件类型："}]},{"type":"codeBlock","attrs":{"language":"text"},"content":[{"type":"text","text":"event: custom-event\\n\ndata: 消息内容\\n\\n"}]},{"type":"heading","attrs":{"level":3,"id":"retry-字段"},"content":[{"type":"text","text":"retry 字段"}]},{"type":"paragraph","content":[{"type":"text","text":"指定重连时间（毫秒）："}]},{"type":"codeBlock","attrs":{"language":"text"},"content":[{"type":"text","text":"retry: 10000\\n\ndata: 消息内容\\n\\n"}]},{"type":"heading","attrs":{"level":2,"id":"Node-服务器实例"},"content":[{"type":"text","text":"Node 服务器实例"}]},{"type":"codeBlock","attrs":{"language":"javascript"},"content":[{"type":"text","text":"const express = require('express');\nconst app = express();\n\napp.get('/events', (req, res) => {\n    // 设置 SSE 所需的 headers\n    res.writeHead(200, {\n        'Content-Type': 'text/event-stream',\n        'Cache-Control': 'no-cache',\n        'Connection': 'keep-alive'\n    });\n\n    // 发送初始数据\n    res.write('data: 连接已建立\\n\\n');\n\n    // 定时发送数据\n    const intervalId = setInterval(() => {\n        const data = {\n            time: new Date().toISOString(),\n            value: Math.random()\n        };\n        \n        res.write(`data: ${JSON.stringify(data)}\\n\\n`);\n    }, 1000);\n\n    // 监听连接关闭\n    req.on('close', () => {\n        clearInterval(intervalId);\n    });\n});\n\napp.listen(3000, () => {\n    console.log('SSE 服务器运行在 3000 端口');\n});"}]},{"type":"heading","attrs":{"level":2,"id":"注意事项"},"content":[{"type":"text","text":"注意事项"}]},{"type":"orderedList","attrs":{"start":1,"type":null},"content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"格式有特定要求：开头为 "},{"type":"text","marks":[{"type":"code"}],"text":"data:"},{"type":"text","text":"、结尾为 "},{"type":"text","marks":[{"type":"code"}],"text":"\\n\\n"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"每个浏览器的并发 SSE 连接数有限制"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"某些代理服务器可能不支持长连接"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"建议实现错误重试机制"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"大规模使用时注意服务器资源管理"}]}]}]},{"type":"paragraph"},{"type":"heading","attrs":{"level":2,"id":"SSE-与-Websocket-的区别"},"content":[{"type":"text","text":"SSE 与 Websocket 的区别"}]},{"type":"heading","attrs":{"level":3,"id":"SSE"},"content":[{"type":"text","marks":[{"type":"bold"}],"text":"SSE"}]},{"type":"paragraph","content":[{"type":"text","text":"SSE 是基于传统的 HTTP 协议实现的，采用了长轮询（long-polling）机制。客户端通过向服务器发送一个 HTTP 请求，服务器保持连接打开并周期性地向客户端发送数据。"}]},{"type":"paragraph","content":[{"type":"text","text":"SSE 通过 "},{"type":"text","marks":[{"type":"code"}],"text":"EventSource"},{"type":"text","text":" 对象来实现，在客户端可以通过监听 "},{"type":"text","marks":[{"type":"code"}],"text":"onmessage"},{"type":"text","text":" 事件来接收服务器端发送的数据。"}]},{"type":"heading","attrs":{"level":3,"id":"WebSocket"},"content":[{"type":"text","marks":[{"type":"bold"}],"text":"WebSocket"}]},{"type":"paragraph","content":[{"type":"text","text":"WebSocket 是基于独立的 TCP 连接实现的，使用自定义的协议。客户端和服务器之间可以建立持久的全双工通信的连接，可以双向发送和接收数据。"}]},{"type":"paragraph","content":[{"type":"text","text":"WebSocket 协议是基于帧的，可以通过发送不同类型的帧进行通信。"}]},{"type":"paragraph"},{"type":"heading","attrs":{"level":2,"id":"总结"},"content":[{"type":"text","text":"总结"}]},{"type":"paragraph","content":[{"type":"text","text":"SSE 是一个简单但强大的服务器推送方案："}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"相比 WebSocket 更轻量，实现更简单"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"单向通信满足大多数推送场景"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"基于 HTTP 协议，兼容性好"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"自动重连机制提高可靠性"}]}]}]},{"type":"paragraph","content":[{"type":"text","text":"适用场景："}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"实时数据更新"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"消息通知"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"日志流式处理"}]}]}]},{"type":"paragraph"},{"type":"heading","attrs":{"level":2,"id":"参考资料"},"content":[{"type":"text","text":"参考资料"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"link","attrs":{"href":"https://www.ruanyifeng.com/blog/2017/05/server-sent_events.html","target":"_blank","rel":"noreferer","class":null}}],"text":"Server-Sent Events 教程 - 阮一峰的网络日志"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"link","attrs":{"href":"https://juejin.cn/post/7487831341591511067","target":"_blank","rel":"noreferer","class":null}}],"text":"高并发场景下，为什么大厂都选择SSE而不是WebSocket？"}]}]}]}]}