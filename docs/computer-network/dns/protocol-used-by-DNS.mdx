---
title: DNS 用的是 TCP 协议还是 UDP 协议
---

import FeatureIcon from "@site/src/components/FeatureIcon";
import dns from "@site/static/img/icon/dns.png";

<FeatureIcon src={dns} title="DNS" />



## DNS 使用的协议

DNS 占用 53 号端口，同时使用 TCP 和 UDP 协议。那么 DNS 在什么情况下使用这两种协议？

- DNS 在区域传输的时候使用TCP协议
- 其他时候使用 UDP 协议



### 区域传输使用 TCP 协议

DNS 的规范规定了2种类型的 DNS 服务器，一个叫主 DNS 服务器，一个叫辅助 DNS 服务器。在一个区中主 DNS 服务器从自己本机的数据文件中读取该区的 DNS 数据信息，而辅助 DN S服务器则从区的主 DNS 服务器中读取该区的 DNS 数据信息。当一个辅助 DNS 服务器启动时，它需要与主 DNS 服务器通信，并加载数据信息，这就叫做区传送（zone transfer）。

1. 辅域名服务器会定时（一般3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，会执行一次区域传送，进行数据同步。区域传送使用 TCP 而不是 UDP，因为数据同步传送的数据量比一个请求应答的数据量要多得多。
2. TCP 是一种可靠连接，保证了数据的准确性。

> 使用 TCP 主要是为了可靠性



### 域名解析时使用 UDP 协议

客户端向 DNS 服务器查询域名，一般返回的内容都不超过 512 字节，用 UDP 传输即可。不用经过三次握手，这样 DNS 服务器负载更低，响应更快。理论上说，客户端也可以指定向 DNS 服务器查询时用 TCP，但事实上，很多 DNS 服务器进行配置的时候，仅支持 UDP 查询包。

> 使用 UDP 是因为 UDP 通信的成本更低，更适合服务器查询域名。可以使得 DNS 服务器负载更低。



## TCP & UDP

TCP（Transmission Control Protocol，传输控制协议）是一种**面向连接的协议**，提供可靠的数据传输，一般服务质量要求比较高的情况，使用这个协议。

UDP（User Data Protocol，用户数据报协议）是一种**无连接的传输层协议**，提供面向事务的简单不可靠信息传送服务。



### **UDP**

UDP 与 TCP 的主要区别在于 UDP 不一定提供可靠的数据传输。事实上，该协议不能保证数据准确无误地到达目的地。UDP 在许多方面非常有效。当某个程序的目标是尽快地传输尽可能多的信息时（其中任意给定数据的重要性相对较低），可使用 UDP。ICQ 短消息使用 UDP 协议发送消息。许多程序将使用单独的 TCP 连接和单独的 UDP 连接。重要的状态信息随可靠的 TCP 连接发送，而主数据流通过 UDP 发送。



### **TCP**

- 应答机制
- 超时重传

TCP 的目的是提供可靠的数据传输，并在相互进行通信的设备或服务之间保持一个虚拟连接。TCP 在数据包接收无序、丢失或在交付期间被破坏时，负责数据恢复。它通过为其发送的每个数据包提供一个序号来完成此恢复。记住，较低的网络层会将每个数据包视为一个独立的单元，因此，数据包可以沿完全不同的路径发送，即使它们都是同一消息的组成部分。这种路由与网络层处理分段和重新组装数据包的方式非常相似，只是级别更高而已。

为确保正确地接收数据，TCP 要求在目标计算机成功收到数据时发回一个确认（即 ACK）。如果在某个时限内未收到相应的 ACK，将重新传送数据包。如果网络拥塞，这种重新传送将导致发送的数据包重复。但是，接收计算机可使用数据包的序号来确定它是否为重复数据包，并在必要时丢弃它。



### TCP 与 UDP 的选择

如果比较 UDP 包和 TCP 包的结构，很明显 UDP 包不具备 TCP 包复杂的可靠性与控制机制。与 TCP 协议相同，UDP 的源端口数和目的端口数也都支持一台主机上的多个应用。一个 16 位的 UDP 包包含了一个字节长的头部和数据的长度，校验码域使其可以进行整体校验。（许多应用只支持 UDP，如：多媒体数据流，不产生任何额外的数据，即使知道有破坏的包也不进行重发。）

很明显，当数据传输的性能必须让位于数据传输的完整性、可控制性和可靠性时，TCP 协议是当然的选择。当强调传输性能而不是传输的完整性时，如：音频和多媒体应用，UDP 是最好的选择。在数据传输时间很短，以至于此前的连接过程成为整个流量主体的情况下，UDP 也是一个好的选择，如：DNS 交换。把 SNMP 建立在 UDP 上的部分原因是设计者认为当发生网络阻塞时，UDP 较低的开销使其有更好的机会去传送管理数据。TCP 丰富的功能有时会导致不可预料的性能低下，但是我们相信在不远的将来，TCP 可靠的点对点连接将会用于绝大多数的网络应用。

TCP 是基于连接的协议，也就是说，在正式收发数据前，必须和对方建立可靠的连接。一个TCP连接必须要经过三次“对话”才能建立起来。三次对话的简单过程：主机 A 向主机 B 发出连接请求数据包：“我想给你发数据，可以吗？”，这是第一次对话；主机 B 向主机 A 发送同意连接和要求同步（同步就是两台主机一个在发送，一个在接收，协调工作）的数据包：“可以，你什么时候发？”，这是第二次对话；主机 A 再发出一个数据包确认主机 B 的要求同步：“我现在就发，你接着吧！”，这是第三次对话。三次“对话”的目的是使数据包的发送和接收同步，经过三次“对话”之后，主机 A 才向主机 B 正式发送数据。

UDP 是与 TCP 相对应的协议。它是面向非连接的协议，它不与对方建立连接，而是直接就把数据包发送过去！UDP 适用于一次只传送少量数据、对可靠性要求不高的应用环境。比如，我们经常使用“ping”命令来测试两台主机之间 TCP/IP 通信是否正常，其实“ping”命令的原理就是向对方主机发送 UDP 数据包，然后对方主机确认收到数据包，如果数据包是否到达的消息及时反馈回来，那么网络就是通的。例如，在默认状态下，一次“ping”操作发送 4 个数据包。大家可以看到，发送的数据包数量是 4 包，收到的也是 4 包（因为对方主机收到后会发回一个确认收到的数据包）。这充分说明了 UDP 协议是面向非连接的协议，没有建立连接的过程。正因为 UDP 协议没有连接的过程，所以它的通信效果高；但也正因为如此，它的可靠性不如 TCP 协议高。HTTP 是用 TCP 协议传输的。



### TCP 与 UDP 的区别

TCP 和 UDP 都是位于 OSI 模型中的传输层中。

TCP 基于面向连接的协议，数据传输可靠，传输速度慢，适用于传输大量数据，可靠性要求高的场合。

UDP 协议面向非连接协议，数据传输不可靠，传输速度快，适用于一次只传送少量数据、对可靠性要求不高的应用环境。

TCP 优点：面向连接的，具有实时性，就象打电话一样，两者必须建立连接。它保证你所传输的东西是准确到达的，并且收方要给你一个收到或没有收到的回复，所以它具有安全性的特点。
UDP 优点：面向无连接的，就象给某人寄信一样，对方不需要在邮局等着你的信到。它没有保障性，不能确保你一定能收到信，不像 TCP 那样，但是它比 TCP 好的一点，就是速度快，因为他不需要双方交流是否收到，对发的东西有一个确认的过程。



#### 面向连接的 TCP

“面向连接”就是在正式通信前必须要与对方建立起连接。比如你给别人打电话，必须等线路接通了、对方拿起话筒才能相互通话。

TCP 协议能为应用程序提供可靠的通信连接，使一台计算机发出的**字节流无差错地发往网络上的其他计算机**，对可靠性要求高的数据通信系统往往使用 TCP 协议传输数据。



#### 面向非连接的 UDP

“面向非连接”就是在正式通信前不必与对方先建立连接，不管对方状态就直接发送。这与现在风行的手机短信非常相似：你在发短信的时候，只需要输入对方手机号就 OK 了。

**UDP 适用于一次只传送少量数据、对可靠性要求不高的应用环境。**

UDP 协议是面向非连接的协议，没有建立连接的过程。正因为 UDP 协议没有连接的过程，所以它的通信效果高；但也正因为如此，它的可靠性不如 TCP 协议高。



### TCP 协议与 UDP 协议支持的应用协议

TCP 支持的应用协议主要有：Telnet、FTP、SMTP等；
UDP 支持的应用层协议主要有：NFS（网络文件系统）、SNMP（简单网络管理协议）、DNS（主域名称系统）、TFTP（通用文件传输协议）等。

UDP 和 TCP 协议的主要区别是两者在如何实现信息的可靠传递方面不同。TCP协议中包含了专门的传递保证机制，当数据接收方收到发送方传来的信息时，会自动向发送方发出确认消息；发送方只有在接收到该确认消息之后才继续传送其它信息，否则将一直等待直到收到确认信息为止。 与 TCP 不同，UDP 协议并不提供数据传送的保证机制。如果在从发送方到接收方的传递过程中出现数据报的丢失，协议本身并不能做出任何检测或提示。因此，通常人们把 UDP 协议称为不可靠的传输协议。相对于 TCP 协议，UDP 协议的另外一个不同之处在于如何接收突发性的多个数据报。不同于 TCP，UDP 并不能确保数据的发送和接收顺序。事实上，UDP 协议的这种乱序性基本上很少出现，通常只会在网络非常拥挤的情况下才有可能发生。

既然 UDP 是一种不可靠的网络协议，那么还有什么使用价值或必要呢？其实不然，在有些情况下 UDP 协议可能会变得非常有用。因为 UDP 具有 TCP 所望尘莫及的速度优势。**虽然 TCP 协议中植入了各种安全保障功能，但是在实际执行的过程中会占用大量的系统开销，无疑使速度受到严重的影响。**反观 UDP 由于排除了信息可靠传递机制，将安全和排序等功能移交给上层应用来完成，极大降低了执行时间，使速度得到了保证。



### DNS 为什么既使用 TCP 又使用 UDP？

首先了解一下 TCP 与 UDP 传送字节的长度限制：

UDP 报文的最大长度为 512 字节，而TCP则允许报文长度超过 512 字节。当 DNS 查询超过 512 字节时，协议的 TC 标志出现删除标志，这时则使用 TCP 发送。通常传统的 UDP 报文一般不会大于512字节。

**区域传送时使用 TCP，主要有一下两点考虑：**

1. 辅域名服务器会定时（一般时3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，则会执行一次区域传送，进行数据同步。区域传送将使用TCP而不是UDP，因为数据同步传送的数据量比一个请求和应答的数据量要多得多。
2. TCP是一种可靠的连接，保证了数据的准确性。

**域名解析时使用 UDP 协议：**

- 客户端向 DNS 服务器查询域名，一般返回的内容都不超过 512 字节，用 UDP 传输即可。不用经过 TCP 三次握手，这样 DNS 服务器负载更低，响应更快。虽然从理论上说，客户端也可以指定向 DNS 服务器查询的时候使用 TCP，但事实上，很多 DNS 服务器进行配置的时候，仅支持 UDP 查询包。

